"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handler=void 0;const client_codepipeline_1=require("@aws-sdk/client-codepipeline"),client=new client_codepipeline_1.CodePipeline({apiVersion:"2015-07-09"}),TIMEOUT_IN_MINUTES=5,sleep=seconds=>new Promise(resolve=>setTimeout(resolve,seconds*1e3));async function handler(event,_context){const{PipelineName:pipelineName,StageName:stageName,ActionName:actionName}=event;function parseState(response){const validStages=response.stageStates?.filter(s=>s.stageName===stageName),manualApproval=validStages.length&&validStages[0].actionStates.filter(state=>state.actionName===actionName),latest=manualApproval&&manualApproval.length&&manualApproval[0].latestExecution;return latest?latest.token:void 0}const deadline=Date.now()+TIMEOUT_IN_MINUTES*6e4;for(;Date.now()<deadline;){const response=await client.getPipelineState({name:pipelineName}),token=parseState(response);if(token){await client.putApprovalResult({pipelineName,actionName,stageName,result:{summary:"No security changes detected. Automatically approved by Lambda.",status:"Approved"},token});return}await sleep(5)}}exports.handler=handler;
